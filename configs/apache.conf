# Apache Virtual Host Configuration for Mercury Relay
# Place this in your Apache sites-available directory

<VirtualHost *:80>
    ServerName mercury-relay.imwald.eu
    DocumentRoot /var/www/html
    
    # Security headers
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Enable mod_rewrite
    RewriteEngine On
    
    # Rate limiting (requires mod_security or mod_evasive)
    # Uncomment if you have mod_evasive installed
    # DOSHashTableSize    2048
    # DOSPageCount        20
    # DOSSiteCount        50
    # DOSPageInterval     1
    # DOSSiteInterval     1
    # DOSBlockingPeriod   600
    
    # Proxy settings for Mercury Relay
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Nostr WebSocket endpoint
    ProxyPass / ws://mercury-relay:8080/
    ProxyPassReverse / ws://mercury-relay:8080/
    
    # WebSocket upgrade headers
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://mercury-relay:8080/$1" [P,L]
    
    # Admin API
    ProxyPass /admin/ http://mercury-relay:8081/
    ProxyPassReverse /admin/ http://mercury-relay:8081/
    
    # REST API
    ProxyPass /api/ http://mercury-relay:8082/
    ProxyPassReverse /api/ http://mercury-relay:8082/
    
    # Health check
    ProxyPass /health http://mercury-relay:8080/health
    ProxyPassReverse /health http://mercury-relay:8080/health
    
    # Favicon
    Alias /favicon.ico /var/www/html/favicon.ico
    Alias /mercury-icon.svg /var/www/html/mercury-icon.svg
    Alias /mercury-icon.png /var/www/html/mercury-icon.png
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/mercury-relay_error.log
    CustomLog ${APACHE_LOG_DIR}/mercury-relay_access.log combined
    
    # Timeout settings for WebSocket
    ProxyTimeout 86400
    ProxyPassTimeout 86400
</VirtualHost>

# HTTPS Virtual Host
<VirtualHost *:443>
    ServerName mercury-relay.imwald.eu
    DocumentRoot /var/www/html
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/mercury-relay.imwald.eu/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/mercury-relay.imwald.eu/privkey.pem
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    
    # Same proxy configuration as HTTP
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Nostr WebSocket endpoint
    ProxyPass / ws://mercury-relay:8080/
    ProxyPassReverse / ws://mercury-relay:8080/
    
    # WebSocket upgrade headers
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://mercury-relay:8080/$1" [P,L]
    
    # Admin API
    ProxyPass /admin/ http://mercury-relay:8081/
    ProxyPassReverse /admin/ http://mercury-relay:8081/
    
    # REST API
    ProxyPass /api/ http://mercury-relay:8082/
    ProxyPassReverse /api/ http://mercury-relay:8082/
    
    # Health check
    ProxyPass /health http://mercury-relay:8080/health
    ProxyPassReverse /health http://mercury-relay:8080/health
    
    # Favicon
    Alias /favicon.ico /var/www/html/favicon.ico
    Alias /mercury-icon.svg /var/www/html/mercury-icon.svg
    Alias /mercury-icon.png /var/www/html/mercury-icon.png
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/mercury-relay_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/mercury-relay_ssl_access.log combined
    
    # Timeout settings for WebSocket
    ProxyTimeout 86400
    ProxyPassTimeout 86400
</VirtualHost>
